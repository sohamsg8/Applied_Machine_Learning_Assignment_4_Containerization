#!/bin/sh

main_branch="main"
current_branch=$(git symbolic-ref --short HEAD 2>/dev/null || git describe --tags --exact-match)

if [ "$current_branch" = "$main_branch" ]; then
  # Stash unstaged changes
  git stash -q --keep-index

  # Run test suite
  pytest test_code.py

  # Store the last command's return status
  result=$?

  # Unstash changes
  git stash pop -q

  # If tests failed, prevent commit
  [ $result -ne 0 ] && { echo "Tests failed. Please fix errors before committing."; exit 1; }
fi

exit 0
